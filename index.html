<!DOCTYPE html>
<html>
<head>
  <meta name="description" content="Demo page combining jQuery Bracket and Group plugins"/>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <script type="text/javascript" src="lib/jquery-1.8.3.min.js"></script>
  <script type="text/javascript" src="lib/Bacon-1ab32ffb.min.js"></script>
  <script type="text/javascript" src="lib/lodash-2.2.1.min.js"></script>
  <script type="text/javascript" src="lib/handlebars.1.0.0.js"></script>
  <script type="text/javascript" src="jquery-group/dist/jquery.group.js"></script>
  <script type="text/javascript" src="jquery-bracket/dist/jquery.bracket.js"></script>
  <link type="text/css" rel="stylesheet" href="jquery-group/dist/jquery.group.min.css"/>
  <link type="text/css" rel="stylesheet" href="jquery-bracket/dist/jquery.bracket.min.css"/>
  <link type="text/css" rel="stylesheet" href="dist/tournament.min.css"/>
  <style>
    body {
      padding: 1%;
      background-color: #EEE;
      padding: 0;
    }

    #group {
      width: 300px;
      background-color: white;
      clear: both;
    }

    #bracket {
      background-color: white;
      float: left;
      clear: both;
    }

    #group .rounds {
      display: none;
    }

    article {
      max-width: 780px;
      background-color: #FFF;
      padding: 20px;
      box-sizing: border-box;
      float: left;
    }

    .wrapper {
      background-color: #F6F6F6;
      padding: 20px;
      float: left;
      clear: both;
      width: 100%;
      box-sizing: border-box;
    }

    #created {
      list-style: none;
      padding: 0;
    }
  </style>
  <script class="demo" type='text/javascript' style="font-size: 90%;"
      >var groupInit = {
    teams: [
      {id: 10, name: "YoDa", faction: "t" },
      {id: 11, name: "First", faction: "p" },
      {id: 12, name: "MC", faction: "p" },
      {id: 13, name: "Ret", faction: "z" },
      {id: 14, name: "Kas", faction: "t" },
      {id: 15, name: "XIorD", faction: "z" }
    ],
    matches: [
      { "id": 0, "round": 1, "a": { "team": 0, "score": 1 }, "b": { "team": 1, "score": 2 } },
      { "id": 1, "round": 1, "a": { "team": 0, "score": 2 }, "b": { "team": 2, "score": 1 } },
      { "id": 2, "round": 1, "a": { "team": 1, "score": 2 }, "b": { "team": 2, "score": 1 } },
      { "id": 3, "round": 2, "a": { "team": 0, "score": 2 }, "b": { "team": 3, "score": 0 } },
      { "id": 4, "round": 2, "a": { "team": 1, "score": 0 }, "b": { "team": 3, "score": 2 } },
      { "id": 5, "round": 2, "a": { "team": 2, "score": 0 }, "b": { "team": 3, "score": 2 } },
      { "id": 6, "round": 3, "a": { "team": 0, "score": 2 }, "b": { "team": 4, "score": 1 } },
      { "id": 7, "round": 3, "a": { "team": 1, "score": 2 }, "b": { "team": 4, "score": 0 } },
      { "id": 8, "round": 3, "a": { "team": 2, "score": 2 }, "b": { "team": 4, "score": 0 } },
      { "id": 9, "round": 4, "a": { "team": 3, "score": 2 }, "b": { "team": 4, "score": 1 } },
      { "id": 10, "round": 4, "a": { "team": 0, "score": 2 }, "b": { "team": 5, "score": 0 } },
      { "id": 11, "round": 4, "a": { "team": 1, "score": 2 }, "b": { "team": 5, "score": 1 } },
      { "id": 12, "round": 5, "a": { "team": 2, "score": 2 }, "b": { "team": 5, "score": 1 } },
      { "id": 13, "round": 5, "a": { "team": 3, "score": 2 }, "b": { "team": 5, "score": 0 } },
      { "id": 14, "round": 5, "a": { "team": 4, "score": 2 }, "b": { "team": 5, "score": 1 } }
    ]
  }

  function faction(faction) {
    colors = { 't': "blue", 'z': "purple", 'p': "goldenrod" }
    return '<span style="padding: 2px; color: white;'
        + 'display: inline-block; text-align: center;'
        + 'font-size: 10px; width: 12px; margin: 0 3px;'
        + 'background-color: ' + colors[faction] + '">' + faction + '</span>'
  }

  function customLabeler(team) {
    return faction(team.faction) + ' ' + team.name
  }

  var bracketInit = {
    teams : [
      [groupInit.teams[0], groupInit.teams[1]],
      [groupInit.teams[2], groupInit.teams[3]]
    ],
    results : [[
      [[1,2], [3,4]],
      [[5,6]]
    ], [
      [[7,8]],
      [[9,10]]
    ], [
      [[1,12], [13,14]],
      [[15,16]]
    ]]
  }

  function render_fn(container, data, score) {
    container.html(customLabeler(data))
  }

  function dumpResponse(data) {
    console.log("RESPONSE")
    console.log(data)
  }

  function server(url) {
    function msg(method, path, data, success) {
      var url = url || "http://127.0.0.1:8080/" + path
      var jsonString = JSON.stringify(data);
      console.log(method + " REQUEST")
      console.log(jsonString)
      $.ajax({type: method,
        url: url,
        dataType: 'json',
        accept: 'application/json',
        crossDomain: true,
        data: jsonString,
        success: success
      })
    }
    return {
      POST: function(type, data, success) {
        msg("POST", type, data, success)
      },
      PUT: function(type, data, success) {
        msg("PUT", type, data, success)
      },
      GET: function(type, success) {
        msg("GET", type, null, success)
      },
      DELETE: function(type, success) {
        msg("DELETE", type, null, success)
      }
    }
  }

  $(function () {
    srv = server()

    ;(function getBrackets() {
      var $created = $("#brackets").empty()
      srv.GET("bracket", function(response) {
        response.keys.forEach(function(k) {
          $item = $("<li>"+k+"</li>").appendTo($created)
          $item.click(function() {
            srv.DELETE("bracket/"+k, getBrackets)
          })
        })
      })
    })()

    ;(function getGroups() {
      var $created = $("#groups").empty()
      srv.GET("group", function(response) {
        response.keys.forEach(function(k) {
          $item = $("<li>"+k+"</li>").appendTo($created)
          $item.click(function() {
            srv.DELETE("group/"+k, getGroups)
          })
        })
      })
    })()

    function createBracket(init) {
      $('div#bracket').bracket({
        init: init,
        decorator: {render: render_fn, edit: function () {
        }},
        save: function (state, userData) {
          state.teams = state.teams.map(function (t) {
            return t.map(function (it) {
              return {id: it.id, name: it.name}
            })
          })
          srv.PUT("bracket/importDemo", state, dumpResponse)
        }
      })
    }

    $("#importBracket").click(function() {
      createBracket(bracketInit);
    })

    $("input#create").click(function(ev) {
      ev.preventDefault()
      var value = $("select").val()
      srv.POST(value, {type: value}, function(response) {
        var $container = $('<li></li>').appendTo($('#'+value+'s'))
        var setup = {init: response}
        console.log(response)
        if (value === 'bracket') {
          $container.bracket($.extend(setup, {save: function(){}}))
        } else if (value === 'group') {
          $container.group($.extend(setup, {save: function(){}}))
        }
      })
    })

    function createGroup(init) {
      $('div#group').group({ init: init, labeler: customLabeler,
        save: function (state) {
          srv.PUT("group/importDemo", state, dumpResponse)
        }
      })
    }

    srv.GET("bracket", function(response) {
      if (_.contains(response.keys, "importDemo")) {
        srv.GET("bracket/importDemo", function(response) {
          createBracket(response)
        })
      }
    })

    srv.GET("group", function(response) {
      if (_.contains(response.keys, "importDemo")) {
        srv.GET("group/importDemo", function(response) {
          createGroup(response)
        })
      }
    })

    $("#importGroup").click(function() {
      createGroup(groupInit)
    })
  })
  </script>
  <title>Tournament plugin demo page</title>
</head>
<body>
<article>
  <h1>Tournament plugin demo page</h1>

  <h2>Create new</h2>

  <form action="http://127.0.0.1:8080/record" method="POST">
    <select>
      <option value="group">Group</option>
      <option value="bracket">Bracket</option>
    </select>
    <input id="create" type="submit" value="Create" />
  </form>

  <h3>Existing (click to delete)</h3>
  <h4>Groups</h4>
  <ul id="groups"></ul>
  <h4>Brackets</h4>
  <ul id="brackets"></ul>

  <h2>Edit group stage <input type="submit" id="importGroup" value="Import example" /></h2>

  <div class="wrapper">
    <div id="group"></div>
  </div>
  <p>IEM Season VII - World Championship group B, data from <a href="http://wiki.teamliquid.net/starcraft2/IEM_Season_VII_-_World_Championship">Liquipedia</a></p>

  <h2>Edit bracket <input type="submit" id="importBracket" value="Import example" /></h2>

  <div class="wrapper">
    <div id="bracket"></div>
  </div>
</article>
</body>
</html>
