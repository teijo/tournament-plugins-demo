<!DOCTYPE html>
<html>
<head>
  <meta name="description" content="Demo page combining jQuery Bracket and Group plugins"/>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <script type="text/javascript" src="lib/jquery-1.8.3.min.js"></script>
  <script type="text/javascript" src="lib/Bacon-1ab32ffb.min.js"></script>
  <script type="text/javascript" src="lib/lodash-2.2.1.min.js"></script>
  <script type="text/javascript" src="lib/handlebars.1.0.0.js"></script>
  <script type="text/javascript" src="jquery-group/dist/jquery.group.js"></script>
  <script type="text/javascript" src="jquery-bracket/dist/jquery.bracket.js"></script>
  <link type="text/css" rel="stylesheet" href="jquery-group/dist/jquery.group.min.css"/>
  <link type="text/css" rel="stylesheet" href="jquery-bracket/dist/jquery.bracket.min.css"/>
  <link type="text/css" rel="stylesheet" href="dist/tournament.min.css"/>
  <style>
    body {
      padding: 1%;
      background-color: #EEE;
      padding: 0;
    }

    #group {
      width: 300px;
      background-color: white;
      clear: both;
    }

    #bracket {
      background-color: white;
      float: left;
      clear: both;
    }

    #group .rounds {
      display: none;
    }

    article {
      max-width: 780px;
      background-color: #FFF;
      padding: 20px;
      box-sizing: border-box;
      float: left;
    }

    .wrapper {
      background-color: #F6F6F6;
      padding: 20px;
      float: left;
      clear: both;
      width: 100%;
      box-sizing: border-box;
    }

    #created {
      list-style: none;
      padding: 0;
    }
  </style>
  <script class="demo" type='text/javascript' style="font-size: 90%;"
      >var groupInit = {
    teams: [
      {id: 10, name: "YoDa",  format: "sc2", data: { faction: "t" } },
      {id: 11, name: "First", format: "sc2", data: { faction: "p" } },
      {id: 12, name: "MC",    format: "sc2", data: { faction: "p" } },
      {id: 13, name: "Ret",   format: "sc2", data: { faction: "z" } },
      {id: 14, name: "Kas",   format: "sc2", data: { faction: "t" } },
      {id: 15, name: "XIorD", format: "sc2", data: { faction: "z" } }
    ],
    matches: [
      { "id": 0, "round": 1, "a": { "team": 0, "score": 1 }, "b": { "team": 1, "score": 2 } },
      { "id": 1, "round": 1, "a": { "team": 0, "score": 2 }, "b": { "team": 2, "score": 1 } },
      { "id": 2, "round": 1, "a": { "team": 1, "score": 2 }, "b": { "team": 2, "score": 1 } },
      { "id": 3, "round": 2, "a": { "team": 0, "score": 2 }, "b": { "team": 3, "score": 0 } },
      { "id": 4, "round": 2, "a": { "team": 1, "score": 0 }, "b": { "team": 3, "score": 2 } },
      { "id": 5, "round": 2, "a": { "team": 2, "score": 0 }, "b": { "team": 3, "score": 2 } },
      { "id": 6, "round": 3, "a": { "team": 0, "score": 2 }, "b": { "team": 4, "score": 1 } },
      { "id": 7, "round": 3, "a": { "team": 1, "score": 2 }, "b": { "team": 4, "score": 0 } },
      { "id": 8, "round": 3, "a": { "team": 2, "score": 2 }, "b": { "team": 4, "score": 0 } },
      { "id": 9, "round": 4, "a": { "team": 3, "score": 2 }, "b": { "team": 4, "score": 1 } },
      { "id": 10, "round": 4, "a": { "team": 0, "score": 2 }, "b": { "team": 5, "score": 0 } },
      { "id": 11, "round": 4, "a": { "team": 1, "score": 2 }, "b": { "team": 5, "score": 1 } },
      { "id": 12, "round": 5, "a": { "team": 2, "score": 2 }, "b": { "team": 5, "score": 1 } },
      { "id": 13, "round": 5, "a": { "team": 3, "score": 2 }, "b": { "team": 5, "score": 0 } },
      { "id": 14, "round": 5, "a": { "team": 4, "score": 2 }, "b": { "team": 5, "score": 1 } }
    ]
  }

  function faction(faction) {
    colors = { 't': "blue", 'z': "purple", 'p': "goldenrod" }
    return '<span style="padding: 2px; color: white;'
        + 'display: inline-block; text-align: center;'
        + 'font-size: 10px; width: 12px; margin: 0 3px;'
        + 'background-color: ' + colors[faction] + '">' + faction + '</span>'
  }

  function customLabeler(team) {
    if (team.data)
      return faction(team.data.faction) + ' ' + team.name
    else
      return team.name
  }

  var bracketInit = {
    teams : [
      [groupInit.teams[0], groupInit.teams[1]],
      [groupInit.teams[2], groupInit.teams[3]]
    ],
    results : [[
      [[1,2], [3,4]],
      [[5,6]]
    ], [
      [[7,8]],
      [[9,10]]
    ], [
      [[1,12], [13,14]],
      [[15,16]]
    ]]
  }

  function render_fn(container, data, score) {
    container.html(customLabeler(data))
  }

  function dumpResponse(data) {
    console.log("RESPONSE")
    console.log(data)
  }

  function getApi(serverUrl) {
    if (!serverUrl)
      throw "Server URL required"
    function msg(method, data, path, success) {
      var requestUrl = serverUrl + path
      var jsonString = JSON.stringify(data);
      $.ajax({type: method,
        url: requestUrl,
        dataType: 'json',
        accept: 'application/json',
        crossDomain: true,
        data: jsonString,
        success: success
      })
    }
    var POST = msg.bind(undefined, "POST")
    var PUT = msg.bind(undefined, "PUT")
    var GET = msg.bind(undefined, "GET", null)
    var DELETE = msg.bind(undefined, "DELETE", null)
    function parseCreate(cb) {
      return function(response) {
        cb(response.id, response.data)
      }
    }
    return {
      createBracket: function(cb) {
        POST({type: "bracket"}, "bracket", parseCreate(cb))
      },
      createGroup: function(cb) {
        POST({type: "group"}, "group", parseCreate(cb))
      },
      saveBracket: function(id, state, cb) {
        PUT(state, "bracket/"+id, cb)
      },
      saveGroup: function(id, state, cb) {
        PUT(state, "group/"+id, cb)
      },
      getBracket: function(id, cb) {
        GET("bracket/"+id, cb)
      },
      getGroup: function(id, cb) {
        GET("group/"+id, cb)
      },
      listBrackets: function(cb)  {
        GET("bracket", cb)
      },
      listGroups: function(cb)  {
        GET("group", cb)
      },
      deleteBracket: function(id, cb) {
        DELETE("bracket/"+id, cb)
      },
      deleteGroup: function(id, cb) {
        DELETE("group/"+id, cb)
      }
    }
  }

  $(function () {
    var api = getApi("http://127.0.0.1:8080/")

    ;(function getBrackets() {
      var $created = $("#brackets").empty()
      api.listBrackets(function(response) {
        response.keys.forEach(function(k) {
          api.getBracket(k, function(response) {
            $item = $("<li></li>").appendTo($created)
            $item.bracket({
              init: response,
              decorator: {render: render_fn, edit: function () {}},
              save: function (state) {
                api.saveBracket(k, state, dumpResponse)
              }
            })
          })
          $del = $("<li>"+k+"</li>").appendTo($created)
          $del.click(function() {
            api.deleteBracket(k, getBrackets)
          })
        })
      })
    })()

    ;(function getGroups() {
      var $created = $("#groups").empty()
      api.listGroups(function(response) {
        response.keys.forEach(function(k) {

          api.getGroup(k, function(response) {
            $item = $("<li></li>").appendTo($created)
            $item.group({
              init: response,
              labeler: customLabeler,
              save: function (state) {
                api.saveGroup(k, state, dumpResponse)
              }
            })
          })

          $del = $("<li>"+k+"</li>").appendTo($created)
          $del.click(function() {
            api.deleteGroup(k, getGroups)
          })
        })
      })
    })()

    function createBracket(id, init) {
      $('div#bracket').bracket({
        init: init,
        decorator: {render: render_fn, edit: function () {
        }},
        save: function (state, userData) {
          api.saveBracket(id, state, dumpResponse)
        }
      })
    }

    $("#importBracket").click(function() {
      createBracket("importDemo", bracketInit);
    })

    $("input#create").click(function(ev) {
      ev.preventDefault()
      var value = $("select").val()
      var createFn = value == "bracket" ? api.createBracket : api.createGroup
      createFn(function(id, response) {
        var $container = $('<li></li>').appendTo($('#'+value+'s'))
        var setup = {init: response}
        if (value === 'bracket') {
          $container.bracket($.extend(setup, {
            save: function (state) {
              api.saveGroup(id, state, dumpResponse)
            }
          }))
        } else if (value === 'group') {
          $container.group($.extend(setup, {
            save: function (state, userData) {
              api.saveBracket(id, state, dumpResponse)
            }
          }))
        }
      })
    })

    function createGroup(id, init) {
      $('div#group').group({ init: init, labeler: customLabeler,
        save: function (state) {
          api.saveGroup(id, state, dumpResponse)
        }
      })
    }

    api.listBrackets(function(response) {
      if (_.contains(response.keys, "importDemo")) {
        api.getBracket("importDemo", function(response) {
          createBracket("importDemo", response)
        })
      }
    })

    api.listGroups(function(response) {
      if (_.contains(response.keys, "importDemo")) {
        api.getGroup("importDemo", function(response) {
          createGroup("importDemo", response)
        })
      }
    })

    $("#importGroup").click(function() {
      createGroup("importDemo", groupInit)
    })
  })
  </script>
  <title>Tournament plugin demo page</title>
</head>
<body>
<article>
  <h1>Tournament plugin demo page</h1>

  <h2>Create new</h2>

  <form action="http://127.0.0.1:8080/record" method="POST">
    <select>
      <option value="group">Group</option>
      <option value="bracket">Bracket</option>
    </select>
    <input id="create" type="submit" value="Create" />
  </form>

  <h3>Existing (click to delete)</h3>
  <h4>Groups</h4>
  <ul id="groups"></ul>
  <h4>Brackets</h4>
  <ul id="brackets"></ul>

  <h2>Edit group stage <input type="submit" id="importGroup" value="Import example" /></h2>

  <div class="wrapper">
    <div id="group"></div>
  </div>
  <p>IEM Season VII - World Championship group B, data from <a href="http://wiki.teamliquid.net/starcraft2/IEM_Season_VII_-_World_Championship">Liquipedia</a></p>

  <h2>Edit bracket <input type="submit" id="importBracket" value="Import example" /></h2>

  <div class="wrapper">
    <div id="bracket"></div>
  </div>
</article>
</body>
</html>
